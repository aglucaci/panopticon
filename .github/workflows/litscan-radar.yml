name: LitScan Radar

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode: daily or weekly"
        required: true
        default: "weekly"
        type: choice
        options:
          - daily
          - weekly

  schedule:
    # Daily: 9:00am ET â‰ˆ 14:00 UTC (standard time) / 13:00 UTC (DST)
    # Keep UTC stable; adjust if you care about DST exactly.
    - cron: "0 13 * * *"

    # Weekly deep scan: Mondays 14:00 UTC
    - cron: "0 14 * * 1"

permissions:
  contents: write

concurrency:
  group: litscan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  litscan:
    runs-on: ubuntu-latest

    env:
      PYTHONUNBUFFERED: "1"
      # Repo path expectations:
      # - script at repo root: daily_pubmed_watch_v2.py
      # - output site in docs/
      # - logo in logos/litscan_logo.png (used by HTML)
      LITSCAN_SCRIPT: scripts/daily_pubmed_watch_v2.py
      LITSCAN_SITE_DIR: docs

      # Defaults (can be overridden below by mode)
      DAYS: "1"
      MAX_RESULTS: "12"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Validate required files exist
        run: |
          set -euo pipefail
          test -f "${LITSCAN_SCRIPT}" || (echo "Missing ${LITSCAN_SCRIPT}" && exit 1)
          test -d "${LITSCAN_SITE_DIR}" || (echo "Missing ${LITSCAN_SITE_DIR}/ directory" && exit 1)

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # LitScan v2 uses requests; keep deps minimal & fast
          pip install requests

      - name: Decide run mode (daily vs weekly)
        id: mode
        run: |
          set -euo pipefail
          MODE="daily"

          # If manual dispatch specifies mode, respect it
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          else
            # If scheduled: choose weekly on Mondays (cron #2), otherwise daily
            # We can't directly read which cron fired; infer by day-of-week UTC.
            DOW="$(date -u +%u)"  # 1=Mon ... 7=Sun
            HOUR="$(date -u +%H)"
            if [ "$DOW" = "1" ] && [ "$HOUR" = "14" ]; then
              MODE="weekly"
            fi
          fi

          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

          if [ "$MODE" = "weekly" ]; then
            echo "DAYS=7" >> "$GITHUB_ENV"
            echo "MAX_RESULTS=25" >> "$GITHUB_ENV"
          else
            echo "DAYS=1" >> "$GITHUB_ENV"
            echo "MAX_RESULTS=12" >> "$GITHUB_ENV"
          fi

      - name: Run LitScan (${{ steps.mode.outputs.mode }})
        run: |
          set -euo pipefail
          echo "Running mode=${{ steps.mode.outputs.mode }} DAYS=${DAYS} MAX=${MAX_RESULTS}"
          python "${LITSCAN_SCRIPT}" --days "${DAYS}" --max "${MAX_RESULTS}"

      - name: Sanity check output
        run: |
          set -euo pipefail
          test -f "${LITSCAN_SITE_DIR}/index.html" || (echo "Missing ${LITSCAN_SITE_DIR}/index.html after run" && exit 1)
          echo "Top of generated index.html:"
          head -n 25 "${LITSCAN_SITE_DIR}/index.html" || true

      - name: Commit changes (only if changed)
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Stage only the site output (and any other outputs you expect)
          git add "${LITSCAN_SITE_DIR}/"

          # Optionally stage other outputs if your script writes them elsewhere:
          # git add outputs/ || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          MSG="LitScan ${{
            steps.mode.outputs.mode
          }} update $(date -u +'%Y-%m-%d')"
          git commit -m "$MSG"
          git push
